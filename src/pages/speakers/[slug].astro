---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import Markdoc from '@markdoc/markdoc';

export async function getStaticPaths() {
  const speakers = await getCollection('speakers');
  const allTalks = await getCollection('talks');

  return speakers.map(speaker => {
    const speakerSlug = speaker.id.replace(/\.md$/, '');

    // Find all talks by this speaker
    const speakerTalks = allTalks.filter(talk =>
      talk.data.speakers?.map(s => s.toLowerCase()).includes(speakerSlug)
    );

    return {
      params: { slug: speakerSlug },
      props: {
        speaker,
        // Pass a simplified list of talks to the page
        talks: speakerTalks.map(t => ({
          slug: t.id.replace(/\.md$/, ''),
          title: t.data.title,
          eventSlug: t.data.eventSlug || 'Past Events'
        }))
      },
    };
  });
}

const { speaker, talks } = Astro.props;
const { data, body } = speaker;

const ast = Markdoc.parse(data.bio || '');
const content = Markdoc.transform(ast);
const html = Markdoc.renderers.html(content);

// Group talks by their eventSlug
const groupedTalks = talks.reduce((acc, talk) => {
  const group = talk.eventSlug;
  if (!acc[group]) {
    acc[group] = [];
  }
  acc[group].push(talk);
  return acc;
}, {});

// Find the most recent event slug for this speaker to provide context to the header
const latestEventSlugForSpeaker = talks.map(t => t.eventSlug).sort().reverse()[0];
const cleanTitle = (title: string) => title.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
---
<Layout title={data.name} eventSlug={latestEventSlugForSpeaker}>
  <div class="container mx-auto px-4 py-16">
    <article class="max-w-3xl mx-auto">
      <header class="mb-8 text-center flex flex-col items-center">
        {data.photo && (
          <div class="w-40 h-40 rounded-full overflow-hidden mb-6 border-4 border-blue-500 shadow-lg">
            <Image
              src={data.photo}
              alt={data.photoAlt || `Photo of ${data.name}`}
              class="w-full h-full object-cover"
              width={160}
              height={160}
            />
          </div>
        )}
        <h1 class="text-4xl md:text-5xl font-extrabold text-white">{data.name}</h1>
        {data.title && <p class="text-xl text-blue-400 mt-2">{data.title}</p>}
        {data.twitter && (
          <a href={`https://twitter.com/${data.twitter.replace('@', '')}`} target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-blue-400 transition-colors mt-2">
            {data.twitter}
          </a>
        )}
        {data.company && <p class="text-lg text-gray-400">{data.company}</p>}
        {data.socialLinks && (
            <div class="flex space-x-4 mt-4">
                {data.socialLinks.map(link => (
                    <a href={link} target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-blue-400 transition-colors">
                        {/* Basic link icon, can be replaced with specific social icons */}
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                    </a>
                ))}
            </div>
        )}
      </header>

      {data.bio && (
        <div class="bg-gray-800 rounded-3xl p-8 border border-gray-700 mt-8">
          <h2 class="text-2xl font-bold text-white mb-4">Bio</h2>
          <div class="prose prose-invert max-w-none text-lg leading-relaxed" set:html={html} />
        </div>
      )}

      {talks && talks.length > 0 && (
        <div class="bg-gray-800 rounded-3xl p-8 border border-gray-700 mt-8">
          <h2 class="text-2xl font-bold text-white mb-4">Talks by {data.name}</h2>
          {Object.entries(groupedTalks).sort((a, b) => b[0].localeCompare(a[0])).map(([eventSlug, eventTalks]) => (
            <div class="mb-6 last:mb-0">
              <h3 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2 mb-3">{eventSlug}</h3>
              <ul class="list-disc list-inside space-y-2">
                {eventTalks.map(talk => (
                  <li>
                    <a href={`/talks/${talk.slug}`} class="text-blue-400 hover:underline text-lg">
                      {cleanTitle(talk.title)}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      )}
    </article>
  </div>
</Layout>