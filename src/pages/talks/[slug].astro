---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Markdoc from '@markdoc/markdoc';

export async function getStaticPaths() {
  const talks = await getCollection('talks');  
  const allSpeakers = await getCollection('speakers');
  const speakerMap = new Map(allSpeakers.map(speaker => [
    speaker.id.replace(/\.md$/, ''), // The slug-like ID from the filename
    speaker.data.name // The proper name from frontmatter
  ]));

  return talks.map(talk => ({
    params: { slug: talk.id.replace(/\.md$/, '') }, // Create slug from filename
    props: { 
      talk,
      // Pass the speaker map to each page
      speakerMap: Object.fromEntries(speakerMap) 
    },
  }));
}

const { talk, speakerMap: speakerMapObject } = Astro.props;
const speakerMap = new Map(Object.entries(speakerMapObject));
const { data, body } = talk;
const abstractExists = typeof data.abstract !== 'undefined';
const renderedBody = body && body.trim() !== '' ? Markdoc.renderers.html(Markdoc.transform(Markdoc.parse(body.trim()))) : null;
// Helper function to strip markdown link syntax: [text](url) -> text
const cleanTitle = (title: string) => title.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');

// Helper function to create a URL-friendly slug from a name
const createSpeakerSlug = (name: string) => name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
---
<Layout title={cleanTitle(data.title)} eventSlug={data.eventSlug}>
  <div class="container mx-auto px-4 py-16">
    <article class="max-w-3xl mx-auto">
      <header class="mb-8 text-center">
        <p class="text-blue-400 font-semibold">{data.track || 'General Session'}</p>
        <h1 class="text-4xl md:text-5xl font-extrabold text-white mt-2">{cleanTitle(data.title)}</h1>
        <div class="mt-4 text-gray-400 space-y-1">
          <p><strong>Speaker:</strong> {
            Array.isArray(data.speakers) && data.speakers.length > 0
              ? data.speakers.map((speaker) => (
                  <a href={`/speakers/${createSpeakerSlug(speaker)}`} class="text-blue-400 hover:underline">{speakerMap.get(speaker.toLowerCase()) || speaker}</a>
                )).reduce((prev, curr) => <>{prev}, {curr}</>)
              : 'TBA'
          }</p>
          <p><strong>Room:</strong> {data.room}</p>
          {data.startTime && data.endTime && (
            <p>
              <strong>Time:</strong>
              {new Date(data.startTime).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })} -
              {new Date(data.endTime).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}
            </p>
          )}
        </div>
      </header>

      {/* Abstract Section - Renders from frontmatter */}
      {abstractExists && (
        <div class="bg-gray-800 rounded-3xl p-8 border border-gray-700 mt-8">
          <div class="prose prose-invert max-w-none">
            <h2 class="text-2xl font-bold text-white mb-4">Abstract</h2>
            <p class="text-lg leading-relaxed">{data.abstract || 'Abstract not available.'}</p>
          </div>
        </div>
      )}

      {/* Additional Content Section - Renders from markdown body */}
      {renderedBody && (
        <div class="bg-gray-800 rounded-3xl p-8 border border-gray-700 mt-8">
          <div class="prose prose-invert max-w-none prose-h2:mt-0">
            <Fragment set:html={renderedBody} />
          </div>
        </div>
      )}
    </article>
  </div>
</Layout>